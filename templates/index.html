<!DOCTYPE html> 
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>‚úàÔ∏è Aviator Pronosticador IA</title>
<style>
body{background:#000;color:cyan;font-family:Arial,sans-serif;text-align:center;margin:0;padding:20px;}
h1{color:#00ffff;margin:6px 0;}
.container{max-width:400px;margin:0 auto;background:#111;padding:20px;border-radius:15px;box-shadow:0 0 15px cyan;display:flex;flex-direction:column;align-items:center;}
#hora-analisis{display:flex;justify-content:space-between;align-items:center;width:100%;margin-bottom:10px;}
#hora{font-size:1.2em;color:#0ff;letter-spacing:1px;}
#analisisInput{width:120px;padding:5px;border:1px solid cyan;background:#000;color:cyan;border-radius:8px;text-align:center;transition:all .3s ease;}
#analizarBtn{padding:6px 10px;background:cyan;color:#000;border:none;border-radius:8px;font-weight:bold;cursor:pointer;}
#display{background:#000;color:#0ff;font-size:2em;padding:10px;border:2px solid cyan;border-radius:10px;min-height:40px;margin-bottom:15px;width:100%;}
.teclado button{width:30%;margin:5px;padding:10px;font-size:1.2em;border-radius:10px;background:#022;color:cyan;border:1px solid #0ff;cursor:pointer;}
.acciones{margin-top:10px;display:flex;justify-content:space-between;flex-wrap:wrap;gap:10px;width:100%;}
.acciones button{flex:1;padding:10px;border-radius:10px;background:cyan;color:black;font-weight:bold;cursor:pointer;}
.limpiar{background:#f00;color:white;margin-top:20px;width:100%;font-weight:bold;border:2px solid #faa;transition:all 0.2s ease;}
.limpiar:hover{background:#c00;box-shadow:0 0 10px red;}
#graficoWrap{width:100%;height:260px;background:#000;border:2px solid cyan;border-radius:10px;padding:8px;box-sizing:border-box;overflow:hidden;margin-top:12px;}
canvas{width:100% !important;height:100% !important;display:block;}
#historial{margin-top:15px;display:flex;flex-wrap:nowrap;overflow-x:auto;overflow-y:hidden;justify-content:flex-start;gap:6px;scrollbar-width:thin;scroll-behavior:smooth;padding-bottom:10px;border-top:1px solid cyan;border-bottom:1px solid cyan;width:100%;}
#historial span{background:#033;padding:5px 10px;border-radius:5px;color:white;white-space:nowrap;flex-shrink:0;font-weight:bold;}
.user-bar{text-align:center;font-size:0.95em;margin-bottom:10px;}
.user-bar span{color:#0ff;font-weight:bold;}
.user-bar a{color:#ff5555;text-decoration:none;font-weight:bold;margin-left:8px;}
.user-bar a:hover{text-decoration:underline;}
</style>
</head>
<body>
<h1>‚úàÔ∏è Aviator Pronosticador IA</h1>

<div class="user-bar">
  <span>üìß {{ usuario }}</span> |
  <a href="/logout">Cerrar sesi√≥n</a>
</div>

<div class="container">
  <div id="hora-analisis">
    <div id="hora"></div>
    <div>
      <input type="text" id="analisisInput" placeholder="1.84x 03:52:27">
      <button id="analizarBtn">Iniciar</button>
    </div>
  </div>

  <div id="display"></div>

  <div class="teclado">
    {% for n in [1,2,3,4,5,6,7,8,9,'.',0,'Borrar'] %}
      <button onclick="tecla('{{n}}')">{{n}}</button>
    {% endfor %}
  </div>

  <div class="acciones">
    <button onclick="guardar()">Ingresar</button>
    <button onclick="deshacer()">‚Ü©Ô∏è Deshacer</button>
  </div>

  <button class="limpiar" onclick="limpiarPantalla()">üßπ Limpiar Pantalla</button>

  <div id="graficoWrap">
    <canvas id="grafico"></canvas>
  </div>
</div>

<h2>Historial</h2>
<div id="historial">
  {% for h in historial %}
    <span>{{'%.2f'|format(h)}}</span>
  {% endfor %}
</div>

<!-- Librer√≠as necesarias -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/hammerjs"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>

<script>
document.addEventListener("DOMContentLoaded",()=>{

  const display = document.getElementById("display");
  const historialDiv = document.getElementById("historial");
  const horaDiv = document.getElementById("hora");
  const graficoCanvas = document.getElementById("grafico").getContext("2d");

  function colorPorCuota(c){if(c<2)return"blue";if(c<10)return"purple";return"pink";}

  const referencePlugin = {
    id:'referenceLines',
    afterDraw:chart=>{
      const ctx=chart.ctx;
      const area=chart.chartArea;
      const yScale=chart.scales['y'];
      const data=chart.data.datasets[0].data;
      if(!data.length)return;

      const maxVal=Math.max(...data);
      const minVal=Math.min(...data);
      const range=maxVal-minVal;
      const soporte1=minVal+(range*0.25);
      const soporte2=minVal+(range*0.1);
      const resistencia1=maxVal-(range*0.25);
      const resistencia2=maxVal-(range*0.1);

      const drawLine=(y,color)=>{const yPix=yScale.getPixelForValue(y);ctx.beginPath();ctx.moveTo(area.left,yPix);ctx.lineTo(area.right,yPix);ctx.lineWidth=2;ctx.strokeStyle=color;ctx.stroke();};

      drawLine(0,'white');
      drawLine(resistencia1,'red');
      drawLine(resistencia2,'red');
      drawLine(soporte1,'lime');
      drawLine(soporte2,'lime');
    }
  };

  const grafico=new Chart(graficoCanvas,{
    type:'line',
    data:{
      labels:[],
      datasets:[{
        label:'Tendencia',
        data:[],
        borderColor:'cyan',
        borderWidth:2,
        pointRadius:5,
        pointBackgroundColor:[],
        tension:0
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{display:false},
        zoom:{
          pan:{enabled:true,mode:'xy'},
          zoom:{wheel:{enabled:true},pinch:{enabled:true},mode:'xy'}
        }
      },
      scales:{
        x:{ticks:{color:'cyan'},grid:{color:'#222'}},
        y:{ticks:{color:'cyan'},grid:{color:'#222'}}
      }
    },
    plugins:[Chart.registry.getPlugin('zoom'),referencePlugin]
  });

  function actualizarGrafico(){
    const cuotas=Array.from(historialDiv.children).map(s=>parseFloat(s.innerText));
    let valor=0;
    const serie=cuotas.map(c=>{if(c<2){valor-=1;}else{valor+=1;}return valor;});
    grafico.data.labels=serie.map((_,i)=>i+1);
    grafico.data.datasets[0].data=serie;
    grafico.data.datasets[0].pointBackgroundColor=cuotas.map(c=>colorPorCuota(c));

    const max=Math.max(...serie,0);
    const min=Math.min(...serie,0);
    const absMax=Math.max(Math.abs(max),Math.abs(min))||1;
    grafico.options.scales.y.min=-absMax-1;
    grafico.options.scales.y.max=absMax+1;
    grafico.update('none');
  }

  window.tecla=t=>{if(t==="Borrar")display.innerText=display.innerText.slice(0,-1);else display.innerText+=t;};
  window.guardar=()=>{
    const cuota=parseFloat(display.innerText.trim());
    if(isNaN(cuota))return;
    const span=document.createElement("span");
    span.innerText=cuota.toFixed(2);
    span.style.color="white";
    historialDiv.appendChild(span);
    historialDiv.scrollLeft=historialDiv.scrollWidth;
    display.innerText="";
    actualizarGrafico();
  };
  window.deshacer=()=>{
    if(historialDiv.lastChild)historialDiv.removeChild(historialDiv.lastChild);
    actualizarGrafico();
  };
  window.limpiarPantalla=()=>{
    if(!confirm("‚ö†Ô∏è ¬øSeguro que deseas borrar el historial y reiniciar la pantalla?"))return;
    historialDiv.innerHTML="";
    grafico.data.labels=[];
    grafico.data.datasets[0].data=[];
    grafico.update();
    alert("‚úÖ Pantalla e historial reiniciados.");
  };

  setInterval(()=>{horaDiv.innerText="üïí "+new Date().toLocaleTimeString('es-ES',{hour12:false});},1000);

  document.getElementById('grafico').addEventListener('dblclick',()=>grafico.resetZoom());
  const ro=new MutationObserver(()=>actualizarGrafico());
  ro.observe(historialDiv,{childList:true});
  actualizarGrafico();
});
</script>
</body>
</html>
