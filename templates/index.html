<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Aviator Pronosticador IA</title>
<style>
body { background:#000; color:cyan; font-family:Arial,sans-serif; text-align:center; margin:0; padding:20px;}
h1{color:#00ffff;}
.container{max-width:400px;margin:0 auto;background:#111;padding:20px;border-radius:15px;box-shadow:0 0 15px cyan;display:flex;flex-direction:column;align-items:center;}
#graficoWrap{width:100%;height:260px;background:#000;border:2px solid cyan;border-radius:10px;padding:8px;box-sizing:border-box;overflow:hidden;}
canvas{width:100% !important;height:100% !important;}
#historial{margin-top:15px;display:flex;flex-wrap:nowrap;overflow-x:auto;gap:6px;padding-bottom:10px;border-top:1px solid cyan;border-bottom:1px solid cyan;width:100%;}
#historial span{background:#033;padding:5px 10px;border-radius:5px;color:white;white-space:nowrap;font-weight:bold;}
.user-bar{margin-bottom:10px;font-size:0.95em;}
.user-bar span{color:#0ff;font-weight:bold;}
.user-bar a{color:#ff5555;text-decoration:none;margin-left:8px;}
/* Mant√©n tus estilos previos para teclado, botones, etc. */
</style>
</head>
<body>
<h1>‚úàÔ∏è Aviator Pronosticador IA</h1>

<div class="user-bar">
  <span>üìß {{ usuario }}</span> |
  <a href="/logout">Cerrar sesi√≥n</a>
</div>

<div class="container">
  <!-- (omito teclado y botones por brevedad, pero est√°n iguales a los tuyos en la versi√≥n real) -->
  <div style="width:100%;margin-bottom:10px;">
    <div id="mensaje_ia"></div>
  </div>

  <div id="graficoWrap">
    <canvas id="grafico"></canvas>
  </div>
</div>

<h2>Historial</h2>
<div id="historial">
  {% for h in historial %}
    <span>{{'%.2f'|format(h)}}</span>
  {% endfor %}
</div>

<!-- Dependencias correctas -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.2.1/dist/chartjs-plugin-zoom.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded",()=>{

  // elementos (adapta si tienes otros nombres)
  const historialDiv = document.getElementById("historial");
  const graficoCanvas = document.getElementById("grafico").getContext("2d");

  // helper color por cuota (igual que tu l√≥gica)
  function colorPorCuota(c){ if(c<2) return "blue"; if(c<10) return "purple"; return "pink"; }

  // plugin para dibujar l√≠neas (central blanca, soporte verde, resistencia roja)
  const referencePlugin = {
    id: 'referenceLines',
    afterDraw: chart => {
      const ctx = chart.ctx;
      const chartArea = chart.chartArea;
      const yScale = chart.scales['y'];
      const data = chart.data.datasets[0].data;
      if(!data || data.length===0) return;

      // calculos: rango sim√©trico en base al valor absoluto max
      const maxVal = Math.max(...data);
      const minVal = Math.min(...data);
      const absMax = Math.max(Math.abs(maxVal), Math.abs(minVal)) || 1;
      // soporte y resistencia colocadas sim√©tricamente respecto a 0
      const resistencia = absMax * 0.7;
      const soporte = -absMax * 0.7;

      const drawLine = (y, color, width=2, dash=[])=>{
        const yPixel = yScale.getPixelForValue(y);
        ctx.save();
        ctx.beginPath();
        ctx.setLineDash(dash);
        ctx.moveTo(chartArea.left, yPixel);
        ctx.lineTo(chartArea.right, yPixel);
        ctx.lineWidth = width;
        ctx.strokeStyle = color;
        ctx.stroke();
        ctx.restore();
      };

      // blanca en 0
      drawLine(0, 'white', 2, []);
      // resistencia (arriba)
      drawLine(resistencia, 'red', 2, []);
      // soporte (abajo)
      drawLine(soporte, 'lime', 2, []);

      // opcional: mostrar valores (n√∫meros) a la derecha
      ctx.save();
      ctx.fillStyle = 'white';
      ctx.font = '12px Arial';
      const pad = 6;
      ctx.fillText(resistencia.toFixed(2), chartArea.right - 40, yScale.getPixelForValue(resistencia) - pad);
      ctx.fillText('0', chartArea.right - 20, yScale.getPixelForValue(0) - pad);
      ctx.fillStyle = 'lime';
      ctx.fillText(soporte.toFixed(2), chartArea.right - 40, yScale.getPixelForValue(soporte) - pad);
      ctx.restore();
    }
  };

  // crea chart con zoom plugin y Hammer habilitado
  const chart = new Chart(graficoCanvas, {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: 'Tendencia',
        data: [],
        borderColor: 'cyan',
        borderWidth: 2,
        pointRadius: 5,
        pointBackgroundColor: [],
        fill: false,
        tension: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'nearest', intersect: false },
      plugins: {
        legend: { display: false },
        zoom: {
          pan: { enabled: true, mode: 'xy', threshold: 5 },
          zoom: {
            wheel: { enabled: true, speed: 0.08 },
            pinch: { enabled: true },
            mode: 'xy'
          }
        }
      },
      scales: {
        x: { ticks: { color: 'cyan' }, grid: { color: '#222' } },
        y: {
          ticks: { color: 'cyan' },
          grid: { color: '#222' },
          // range se ajustar√° en updateChart() para ser sim√©trico alrededor de 0
        }
      }
    },
    plugins: [ Chart.registry.getPlugin('zoom'), referencePlugin ]
  });

  // habilitar pinch-to-zoom con Hammer (evita comportamiento por defecto del navegador)
  const hammerManager = new Hammer(document.getElementById('grafico'));
  hammerManager.get('pinch').set({ enable: true });
  hammerManager.on('pinchstart pinchmove pinchend', function(ev){
    // chartjs-plugin-zoom ya maneja pinch si pinch.enabled=true; aqu√≠ evitamos el scroll del navegador
    ev.preventDefault();
  });

  // funci√≥n para actualizar datos usando la misma l√≥gica que usas:
  function actualizarGraficoDesdeHistorial(){
    const cuotas = Array.from(historialDiv.children).map(s => parseFloat(s.innerText));
    // reproducir tu l√≥gica: acumulado +1/-1 seg√∫n cuota <2
    let valor = 0;
    const serie = cuotas.map(c => { if(c < 2) { valor -= 1; } else { valor += 1; } return valor; });

    // actualizar dataset
    chart.data.labels = serie.map((_,i) => i+1);
    chart.data.datasets[0].data = serie;
    // pintar puntos con colores seg√∫n cuotas (mismo orden)
    chart.data.datasets[0].pointBackgroundColor = cuotas.map(c => colorPorCuota(c));

    // ajustar eje Y: sim√©trico alrededor de 0 con margen
    const max = Math.max(...serie, 0);
    const min = Math.min(...serie, 0);
    const absMax = Math.max(Math.abs(max), Math.abs(min)) || 1;
    const padding = 1;
    chart.options.scales.y.min = -absMax - padding;
    chart.options.scales.y.max = absMax + padding;

    chart.update('none'); // 'none' para no animar y que afterDraw dibuje las l√≠neas inmediatamente
  }

  // expose a window function para pruebas (si quieres)
  window.actualizarGraficoDesdeHistorial = actualizarGraficoDesdeHistorial;

  // Llama a la actualizaci√≥n al cargar (si ya hay historial)
  actualizarGraficoDesdeHistorial();

  // Observador simple: cuando cambie el historial (DOM), actualizamos el gr√°fico
  const ro = new MutationObserver(()=> actualizarGraficoDesdeHistorial());
  ro.observe(historialDiv, { childList: true, subtree: false });

  // Reseteo del zoom con doble clic (doble toque en m√≥vil)
  document.getElementById('grafico').addEventListener('dblclick', ()=> {
    chart.resetZoom();
  });

  // Opcional: evitar el cuadro de selecci√≥n al arrastrar (no usar drag-to-zoom)
  // el plugin no activa "drag zoom" por defecto aqu√≠; wheel+pinch+pan est√°n activos.

}); // DOMContentLoaded
</script>
</body>
</html>
