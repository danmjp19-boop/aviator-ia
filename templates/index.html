<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>‚úàÔ∏è Aviator Pronosticador IA</title>
<style>
/* tus estilos EXACTOS (no modifiqu√© visual) */
body{background:#000;color:cyan;font-family:Arial,sans-serif;text-align:center;margin:0;padding:20px;}
h1{color:#00ffff;margin:6px 0;}
.container{max-width:400px;margin:0 auto;background:#111;padding:20px;border-radius:15px;box-shadow:0 0 15px cyan;display:flex;flex-direction:column;align-items:center;}
#hora-analisis{display:flex;justify-content:space-between;align-items:center;width:100%;margin-bottom:10px;}
#hora{font-size:1.2em;color:#0ff;letter-spacing:1px;}
#analisisInput{width:120px;padding:5px;border:1px solid cyan;background:#000;color:cyan;border-radius:8px;text-align:center;}
#analizarBtn{padding:6px 10px;background:cyan;color:#000;border:none;border-radius:8px;font-weight:bold;cursor:pointer;}
#display{background:#000;color:#0ff;font-size:2em;padding:10px;border:2px solid cyan;border-radius:10px;min-height:40px;margin-bottom:15px;width:100%;}
.teclado button{width:30%;margin:5px;padding:10px;font-size:1.2em;border-radius:10px;background:#022;color:cyan;border:1px solid #0ff;cursor:pointer;}
.acciones{margin-top:10px;display:flex;justify-content:space-between;flex-wrap:wrap;gap:10px;width:100%;}
.acciones button{flex:1;padding:10px;border-radius:10px;background:cyan;color:black;font-weight:bold;cursor:pointer;}
.limpiar{background:#f00;color:white;margin-top:20px;width:100%;font-weight:bold;border:2px solid #faa;}
#graficoWrap{width:100%;height:260px;background:#000;border:2px solid cyan;border-radius:10px;padding:8px;margin-top:12px;overflow:hidden;}
/* importante para gestos en m√≥vil */
#graficoWrap canvas{width:100%!important;height:100%!important;display:block;touch-action:none;-ms-touch-action:none;}
#mensaje_ia{margin-top:15px;font-size:1.2em;color:lime;min-height:1.5em;}
#historial{margin-top:15px;display:flex;overflow-x:auto;gap:6px;padding-bottom:10px;border-top:1px solid cyan;border-bottom:1px solid cyan;width:100%;}
#historial span{background:#033;padding:5px 10px;border-radius:5px;color:white;white-space:nowrap;font-weight:bold;}
.user-bar{margin-bottom:10px;text-align:center;font-size:0.95em;}
.user-bar span{color:#0ff;font-weight:bold;}
.user-bar a{color:#ff5555;text-decoration:none;font-weight:bold;margin-left:8px;}
.user-bar a:hover{text-decoration:underline;}
</style>
</head>
<body>
<h1>‚úàÔ∏è Aviator Pronosticador IA</h1>

<div class="user-bar">
  <span>üìß {{ usuario }}</span> |
  <a href="/logout">Cerrar sesi√≥n</a>
</div>

<div class="container">
  <div id="hora-analisis">
    <div id="hora"></div>
    <div>
      <input type="text" id="analisisInput" placeholder="1.84x 03:52:27">
      <button id="analizarBtn">Iniciar</button>
    </div>
  </div>

  <div id="display"></div>

  <div class="teclado">
    {% for n in [1,2,3,4,5,6,7,8,9,'.',0,'Borrar'] %}
      <button onclick="tecla('{{n}}')">{{n}}</button>
    {% endfor %}
  </div>

  <div class="acciones">
    <button onclick="guardar()">Ingresar</button>
    <button onclick="deshacer()">‚Ü©Ô∏è Deshacer</button>
  </div>

  <button class="limpiar" onclick="limpiarPantalla()">üßπ Limpiar Pantalla</button>

  <div id="mensaje_ia"></div>

  <div id="graficoWrap">
    <canvas id="grafico"></canvas>
  </div>
</div>

<h2>Historial</h2>
<div id="historial">
  {% for h in historial %}
    <span>{{'%.2f'|format(h)}}</span>
  {% endfor %}
</div>

<!-- librer√≠as (compatibles con tu versi√≥n) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.2.1/dist/chartjs-plugin-zoom.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded",()=>{

  const display=document.getElementById("display");
  const historialDiv=document.getElementById("historial");
  const mensajeIA=document.getElementById("mensaje_ia");
  const horaDiv=document.getElementById("hora");
  const input=document.getElementById("analisisInput");
  const btn=document.getElementById("analizarBtn");
  const graficoCtx=document.getElementById("grafico").getContext("2d");

  function colorPorCuota(c){if(c<2)return"blue";if(c<10)return"purple";return"pink";}

  // plugin de l√≠neas (soportes/resistencias globales)
  const referencePlugin={
    id:'referenceLines',
    afterDraw:chart=>{
      const ctx=chart.ctx, area=chart.chartArea, yScale=chart.scales['y'];
      const data=chart.data.datasets[0].data;
      if(!data||data.length===0) return;
      const maxVal=Math.max(...data);
      const minVal=Math.min(...data);
      const soporte=minVal, resistencia=maxVal;
      const soporte2=soporte + (resistencia-soporte)*0.25;
      const resistencia2=resistencia - (resistencia-soporte)*0.25;
      const drawLine=(y,color,w=2,dash=[])=>{
        const yPixel=yScale.getPixelForValue(y);
        ctx.save(); ctx.beginPath(); ctx.setLineDash(dash);
        ctx.moveTo(area.left,yPixel); ctx.lineTo(area.right,yPixel);
        ctx.lineWidth=w; ctx.strokeStyle=color; ctx.stroke(); ctx.restore();
      };
      drawLine(resistencia,'red',2,[]);
      drawLine(resistencia2,'red',1,[6,4]);
      drawLine(soporte2,'lime',1,[6,4]);
      drawLine(soporte,'lime',2,[]);
    }
  };

  // helper para validar/clampear escalas tras zoom/pan
  function clampOrResetScales(chart){
    try{
      const y = chart.scales['y'];
      if(!y) return;
      let min = Number(y.min);
      let max = Number(y.max);
      if(!isFinite(min) || !isFinite(max) || Math.abs(max - min) < 0.05){
        // rango inv√°lido o demasiado peque√±o -> resetear zoom
        chart.resetZoom();
        return;
      }
      // evitar zoom desproporcionado: l√≠mite relativo al rango de datos
      const data = chart.data.datasets[0].data || [];
      const absMaxData = Math.max(1, Math.abs(Math.max(...data)), Math.abs(Math.min(...data)));
      const limit = Math.max(5, absMaxData * 10); // no permitir zoom fuera de +-limit
      if(min < -limit) min = -limit;
      if(max > limit) max = limit;
      // aplicar si se cambi√≥
      if(min !== y.min || max !== y.max){
        chart.options.scales.y.min = min;
        chart.options.scales.y.max = max;
        chart.update('none');
      }
    }catch(e){
      // en caso de error, resetear
      chart.resetZoom();
    }
  }

  // crear gr√°fico (igual a tu estructura)
  const grafico=new Chart(graficoCtx,{
    type:'line',
    data:{ labels:[], datasets:[{ label:'Tendencia', data:[], borderColor:'cyan', borderWidth:2, pointRadius:5, pointBackgroundColor:[], tension:0 }]},
    options:{
      responsive:true,
      maintainAspectRatio:false,
      interaction:{ mode:'nearest', intersect:false },
      plugins:{
        legend:{ display:false },
        zoom:{
          pan:{
            enabled:true,
            mode:'xy',
            modifierKey:null,
            threshold:5
          },
          zoom:{
            wheel:{ enabled:true, speed:0.12, threshold:1 },
            pinch:{ enabled:true, threshold:1 },
            mode:'xy',
            // callback llamado durante el zoom
            onZoom:({chart})=>{
              // validar escalas cada vez que zoom cambia
              clampOrResetScales(chart);
            }
          }
        }
      },
      scales:{
        x:{ ticks:{ color:'cyan' }, grid:{ color:'#222' } },
        y:{ ticks:{ color:'cyan' }, grid:{ color:'#222' } }
      }
    },
    plugins:[ Chart.registry.getPlugin('zoom'), referencePlugin ]
  });

  // Hammer para pinch (evita comportamiento nativo)
  const hammerArea = new Hammer(document.getElementById('grafico'));
  hammerArea.get('pinch').set({ enable: true });
  hammerArea.on('pinchstart pinchmove pinchend', e => e.preventDefault());

  // actualizar gr√°fico con tu l√≥gica
  function actualizarGrafico(){
    const cuotas = Array.from(historialDiv.children).map(s => parseFloat(s.innerText));
    if(cuotas.length === 0){
      grafico.data.labels = []; grafico.data.datasets[0].data = []; grafico.update(); return;
    }
    let valor=0;
    const serie = cuotas.map(c => { valor += (c<2 ? -1 : 1); return valor; });
    grafico.data.labels = serie.map((_,i)=>i+1);
    grafico.data.datasets[0].data = serie;
    grafico.data.datasets[0].pointBackgroundColor = cuotas.map(c => colorPorCuota(c));
    // eje Y sim√©trico
    const max = Math.max(...serie,0), min = Math.min(...serie,0);
    const absMax = Math.max(Math.abs(max), Math.abs(min)) || 1;
    grafico.options.scales.y.min = -absMax - 1;
    grafico.options.scales.y.max = absMax + 1;
    grafico.update('none');
  }

  // UI: mismas funciones tuyas
  window.tecla = t => { if(t==="Borrar") display.innerText = display.innerText.slice(0,-1); else display.innerText += t; };

  window.guardar = () => {
    const cuota = parseFloat(display.innerText.trim());
    if(isNaN(cuota)) return;
    fetch("/guardar", { method:"POST", headers:{"Content-Type":"application/x-www-form-urlencoded"}, body: new URLSearchParams({cuota}) })
      .then(r=>r.json()).then(d=>{
        display.innerText = "";
        mensajeIA.innerText = (d.prediccion && d.prediccion !== "clear") ? d.prediccion : "";
        const span = document.createElement("span");
        span.innerText = cuota.toFixed(2);
        span.style.color = "white";
        historialDiv.appendChild(span);
        historialDiv.scrollLeft = historialDiv.scrollWidth;
        actualizarGrafico();
      }).catch(()=>{
        // fallback local si falla la petici√≥n
        const span = document.createElement("span");
        span.innerText = cuota.toFixed(2);
        span.style.color = "white";
        historialDiv.appendChild(span);
        historialDiv.scrollLeft = historialDiv.scrollWidth;
        actualizarGrafico();
      });
  };

  window.deshacer = () => {
    fetch("/borrar_ultimo",{method:"POST"}).then(()=>{
      if(historialDiv.lastChild) historialDiv.removeChild(historialDiv.lastChild);
      mensajeIA.innerText = ""; actualizarGrafico();
    }).catch(()=>{ if(historialDiv.lastChild) historialDiv.removeChild(historialDiv.lastChild); actualizarGrafico(); });
  };

  window.limpiarPantalla = () => {
    if(!confirm("‚ö†Ô∏è ¬øSeguro que deseas borrar el historial y reiniciar la pantalla?")) return;
    fetch("/limpiar_todo",{method:"POST"}).then(()=>{
      historialDiv.innerHTML = ""; mensajeIA.innerText = ""; display.innerText = "";
      grafico.data.labels = []; grafico.data.datasets[0].data = []; grafico.update();
      alert("‚úÖ Pantalla e historial reiniciados.");
    }).catch(()=>{ historialDiv.innerHTML = ""; grafico.data.labels = []; grafico.data.datasets[0].data = []; grafico.update(); });
  };

  // parse input helper
  btn.onclick = () => {
    const texto = input.value.trim();
    const match = texto.match(/([\d.]+)x\s*(\d{2}):(\d{2}):(\d{2})/);
    if(!match) return;
    const mult = parseFloat(match[1]);
    const h = parseInt(match[2]), m = parseInt(match[3]), s = parseInt(match[4]);
    const base = new Date(); base.setHours(h,m,s,0);
    const nuevo = new Date(base.getTime() + mult*60000);
    const nh = String(nuevo.getHours()).padStart(2,"0");
    const nm = String(nuevo.getMinutes()).padStart(2,"0");
    const ns = String(nuevo.getSeconds()).padStart(2,"0");
    input.value = `${match[1]}x ${nh}:${nm}:${ns}`;
  };

  // reloj
  function actualizarHora(){ horaDiv.innerText = "üïí " + new Date().toLocaleTimeString('es-ES',{hour12:false}); }
  setInterval(actualizarHora,1000);
  actualizarHora();

  // reset zoom con dblclick
  document.getElementById('grafico').addEventListener('dblclick', ()=> grafico.resetZoom());

  // observar historial y actualizar
  const ro = new MutationObserver(()=> {
    actualizarGrafico();
    // al actualizar tambi√©n validamos escalas por si hay zoom aplicado
    clampOrResetScales(grafico);
  });
  ro.observe(historialDiv, { childList: true });

  // inicio
  actualizarGrafico();

});
</script>
</body>
</html>
