<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const display = document.getElementById("display");
const historialDiv = document.getElementById("historial");
const mensajeIA = document.getElementById("mensaje_ia");
const horaDiv = document.getElementById("hora");
const ctx = document.getElementById("grafico").getContext("2d");

let datos = [];
let grafico = new Chart(ctx, {
    type: "line",
    data: {
        labels: [],
        datasets: [{
            label: "Tendencia",
            data: [],
            borderColor: "cyan",
            borderWidth: 1.5,
            pointRadius: 4,
            pointBackgroundColor: [],
            tension: 0
        }]
    },
    options: {
        responsive: true,
        animation: false,
        scales: {
            x: {
                ticks: { color: "#0ff" },
                grid: { color: "#033" }
            },
            y: { 
                ticks: { color: "#0ff" },
                grid: { color: ctx => ctx.tick.value === 0 ? 'red' : '#333' },
                min: -1.5,
                max: 1.5
            }
        },
        plugins: { legend: { labels: { color: "#0ff" } } }
    }
});

function actualizarHora() {
    horaDiv.innerText = "üïí " + new Date().toLocaleTimeString('es-ES', {hour12:false});
}
setInterval(actualizarHora, 1000);
actualizarHora();

function tecla(t) {
    if (t === "Borrar") display.innerText = display.innerText.slice(0, -1);
    else display.innerText += t;
}

function guardar() {
    const cuota = display.innerText.trim();
    if (!cuota) return;

    fetch("/guardar", {
        method: "POST",
        headers: {"Content-Type": "application/x-www-form-urlencoded"},
        body: new URLSearchParams({cuota})
    })
    .then(r => r.json())
    .then(d => {
        display.innerText = "";

        if (d.prediccion && d.prediccion !== "clear") {
            mensajeIA.innerText = d.prediccion;
            mensajeIA.style.opacity = 1;
        } else {
            mensajeIA.innerText = "";
            mensajeIA.style.opacity = 0;
        }

        const valor = parseFloat(cuota);
        const referencia = 1.5;
        const normalizado = Math.max(-1.5, Math.min((valor - referencia) / 1.5, 1.5));

        let color = valor < 2 ? "blue" : valor < 10 ? "purple" : "pink";

        datos.push(normalizado);
        grafico.data.labels.push(datos.length);
        grafico.data.datasets[0].data.push(normalizado);
        grafico.data.datasets[0].pointBackgroundColor.push(color);
        grafico.update();

        const span = document.createElement("span");
        span.innerText = valor.toFixed(2);
        historialDiv.appendChild(span);
        historialDiv.scrollLeft = historialDiv.scrollWidth;
        actualizarAnalisis();
    })
    .catch(() => alert("‚ö†Ô∏è Error al conectar con el servidor."));
}

function deshacer() {
    fetch("/borrar_ultimo", {method:"POST"}).then(()=>{
        if (datos.length>0){
            datos.pop();
            grafico.data.labels.pop();
            grafico.data.datasets[0].data.pop();
            grafico.data.datasets[0].pointBackgroundColor.pop();
            grafico.update();
        }
        if (historialDiv.children.length>0)
            historialDiv.removeChild(historialDiv.lastChild);
        mensajeIA.innerText = "";
        mensajeIA.style.opacity = 0;
        actualizarAnalisis();
    });
}

function limpiarPantalla(){
    if(!confirm("‚ö†Ô∏è ¬øSeguro que deseas borrar todo y reiniciar?")) return;
    fetch("/limpiar_todo",{method:"POST"})
    .then(()=> {
        historialDiv.innerHTML="";
        display.innerText="";
        mensajeIA.innerText="";
        mensajeIA.style.opacity=0;
        datos=[];
        grafico.data.labels=[];
        grafico.data.datasets[0].data=[];
        grafico.data.datasets[0].pointBackgroundColor=[];
        grafico.update();
        alert("‚úÖ Pantalla e historial reiniciados.");
        actualizarAnalisis();
    });
}

function actualizarAnalisis(){
    fetch("/analisis")
    .then(r=>r.json())
    .then(d=>{
        document.getElementById("resumen_analitico").innerText = d.resumen;
    })
    .catch(()=>{
        document.getElementById("resumen_analitico").innerText = "Error al obtener an√°lisis.";
    });
}

actualizarAnalisis();
setInterval(actualizarAnalisis, 5000);
</script>
