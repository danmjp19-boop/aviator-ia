<script>
const display = document.getElementById("display");
const historialDiv = document.getElementById("historial");
const mensajeIA = document.getElementById("mensaje_ia");
const horaDiv = document.getElementById("hora");
const ctx = document.getElementById("grafico").getContext("2d");
let datos = [];

const grafico = new Chart(ctx, {
    type: 'line',
    data: {
        labels: [],
        datasets: [{
            label: 'Tendencia',
            data: [],
            borderColor: 'cyan',
            borderWidth: 2,
            pointRadius: 5,
            pointBackgroundColor: [],
            tension: 0 // â† rectas sin curvas
        }]
    },
    options: {
        responsive: true,
        scales: {
            x: { ticks: { color: 'cyan' } },
            y: {
                ticks: { color: 'cyan' },
                min: -1.5,
                max: 1.5,
                grid: {
                    color: ctx => ctx.tick.value === 0 ? 'cyan' : '#033',
                    lineWidth: ctx => ctx.tick.value === 0 ? 2 : 1
                }
            }
        },
        plugins: { legend: { labels: { color: 'cyan' } } }
    }
});

function actualizarHora(){
    horaDiv.innerText = "ðŸ•’ " + new Date().toLocaleTimeString('es-ES', {hour12:false});
}
setInterval(actualizarHora, 1000); actualizarHora();

function tecla(t){
    if(t === "Borrar") display.innerText = display.innerText.slice(0,-1);
    else display.innerText += t;
}

function guardar(){
    const cuota = display.innerText.trim();
    if(!cuota) return;
    fetch("/guardar",{
        method:"POST",
        headers:{"Content-Type":"application/x-www-form-urlencoded"},
        body:new URLSearchParams({cuota})
    })
    .then(r=>r.json())
    .then(d=>{
        display.innerText="";
        mensajeIA.style.opacity=0;
        setTimeout(()=>{
            mensajeIA.innerText = d.prediccion && d.prediccion !== "clear" ? "ðŸŸ¢ "+d.prediccion : "";
            mensajeIA.style.opacity=1;
        },300);

        const valor = parseFloat(cuota);
        let nivel = 0;
        let color = "cyan";

        if (valor >= 1.00 && valor < 2.00) { // Bajista
            nivel = -1; color = "blue";
        } else if (valor >= 2.00 && valor < 10.00) { // Alcista
            nivel = 1; color = "purple";
        } else if (valor >= 10.00) { // EsporÃ¡dica
            nivel = 1; color = "pink";
        }

        datos.push(nivel);
        grafico.data.labels.push(datos.length);
        grafico.data.datasets[0].data.push(nivel);
        grafico.data.datasets[0].pointBackgroundColor.push(color);
        grafico.update();

        const span=document.createElement("span");
        span.innerText = valor.toFixed(2);
        historialDiv.appendChild(span);
        historialDiv.scrollLeft = historialDiv.scrollWidth;
    });
}

function deshacer(){
    fetch("/borrar_ultimo",{method:"POST"}).then(()=>{
        if(datos.length>0){
            datos.pop();
            grafico.data.labels.pop();
            grafico.data.datasets[0].data.pop();
            grafico.data.datasets[0].pointBackgroundColor.pop();
            grafico.update();
        }
        if(historialDiv.children.length>0) historialDiv.removeChild(historialDiv.lastChild);
        mensajeIA.innerText="";
    });
}

function limpiarPantalla(){
    if(!confirm("âš ï¸ Â¿Seguro que deseas borrar todo y reiniciar?")) return;
    fetch("/limpiar_todo",{method:"POST"})
    .then(()=> {
        historialDiv.innerHTML="";
        display.innerText="";
        mensajeIA.innerText="";
        datos=[];
        grafico.data.labels=[];
        grafico.data.datasets[0].data=[];
        grafico.data.datasets[0].pointBackgroundColor=[];
        grafico.update();
        alert("âœ… Pantalla e historial reiniciados.");
    });
}
</script>
