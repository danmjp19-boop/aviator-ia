<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‚úàÔ∏è Aviator Pronosticador IA</title>
<style>
body { background-color:#000; color:cyan; font-family:Arial,sans-serif; text-align:center; margin:0; padding:20px; }
h1 { color:#00ffff; }
.container { max-width:400px; margin:0 auto; background:#111; padding:20px; border-radius:15px; box-shadow:0 0 15px cyan; display:flex; flex-direction:column; align-items:center; }
#hora-analisis { display:flex; justify-content:space-between; align-items:center; width:100%; margin-bottom:10px; }
#hora { font-size:1.2em; color:#0ff; letter-spacing:1px; }
#analisisInput { width:120px; padding:5px; border:1px solid cyan; background:#000; color:cyan; border-radius:8px; text-align:center; transition:all .3s ease; }
#analizarBtn { padding:6px 10px; background:cyan; color:#000; border:none; border-radius:8px; font-weight:bold; cursor:pointer; }
#analizarBtn:hover { background:#0ff; }
.titilar { animation: titilarAnim 1s infinite alternate; }
@keyframes titilarAnim { 
  0% { box-shadow:0 0 5px cyan; color:cyan; } 
  100% { box-shadow:0 0 20px #00ffff; color:white; } 
}
#display { background:#000; color:#0ff; font-size:2em; padding:10px; border:2px solid cyan; border-radius:10px; min-height:40px; margin-bottom:15px; width:100%; }
.teclado button { width:30%; margin:5px; padding:10px; font-size:1.2em; border-radius:10px; background:#022; color:cyan; border:1px solid #0ff; cursor:pointer; }
.acciones { margin-top:10px; display:flex; justify-content:space-between; flex-wrap:wrap; gap:10px; width:100%; }
.acciones button { flex:1; padding:10px; border-radius:10px; background:cyan; color:black; font-weight:bold; cursor:pointer; }
.limpiar { background:#f00; color:white; margin-top:20px; width:100%; font-weight:bold; border:2px solid #faa; transition:all 0.2s ease; }
.limpiar:hover { background:#c00; box-shadow:0 0 10px red; }
#mensaje_ia { margin-top:15px; font-size:1.2em; color:lime; min-height:1.5em; transition:opacity .3s ease; }
#grafico { background:#000; border:2px solid cyan; border-radius:10px; margin-top:15px; height:180px; width:100%; }
#historial { margin-top:15px; display:flex; flex-wrap:nowrap; overflow-x:auto; overflow-y:hidden; justify-content:flex-start; gap:6px; scrollbar-width:thin; scroll-behavior:smooth; padding-bottom:10px; border-top:1px solid cyan; border-bottom:1px solid cyan; width:100%; }
#historial span { background:#033; padding:5px 10px; border-radius:5px; color:#0ff; white-space:nowrap; flex-shrink:0; font-weight:bold; }
.user-bar { margin-bottom:10px; text-align:center; font-size:0.95em; }
.user-bar span { color:#0ff; font-weight:bold; }
.user-bar a { color:#ff5555; text-decoration:none; font-weight:bold; margin-left:8px; }
.user-bar a:hover { text-decoration:underline; }
</style>
</head>
<body>
<h1>‚úàÔ∏è Aviator Pronosticador IA</h1>

<div class="user-bar">
  <span>üìß {{ usuario }}</span> |
  <a href="/logout">Cerrar sesi√≥n</a>
</div>

<div class="container">
  <div id="hora-analisis">
    <div id="hora"></div>
    <div>
      <input type="text" id="analisisInput" placeholder="1.84x 03:52:27">
      <button id="analizarBtn">Iniciar</button>
    </div>
  </div>

  <div id="display"></div>

  <div class="teclado">
    {% for n in [1,2,3,4,5,6,7,8,9,'.',0,'Borrar'] %}
      <button onclick="tecla('{{n}}')">{{n}}</button>
    {% endfor %}
  </div>

  <div class="acciones">
    <button onclick="guardar()">Ingresar</button>
    <button onclick="deshacer()">‚Ü©Ô∏è Deshacer</button>
  </div>

  <button class="limpiar" onclick="limpiarPantalla()">üßπ Limpiar Pantalla</button>

  <div id="mensaje_ia"></div>
  <div style="width:100%; overflow-x:auto;">
    <canvas id="grafico"></canvas>
  </div>
</div>

<h2>Historial</h2>
<div id="historial">
  {% for h in historial %}
    <span>{{'%.2f'|format(h)}}</span>
  {% endfor %}
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded",()=>{
  const display=document.getElementById("display");
  const historialDiv=document.getElementById("historial");
  const mensajeIA=document.getElementById("mensaje_ia");
  const horaDiv=document.getElementById("hora");
  const ctx=document.getElementById("grafico").getContext("2d");
  const input=document.getElementById("analisisInput");
  const btn=document.getElementById("analizarBtn");

  let tiempoObjetivo=null;
  let usuarioMoviendoGrafico=false;

  let grafico=new Chart(ctx,{
    type:"line",
    data:{labels:[],datasets:[{label:"Tendencia",data:[],borderColor:"cyan",borderWidth:2,pointRadius:4,pointBackgroundColor:"cyan",tension:0}]},
    options:{
      responsive:true,
      plugins:{legend:{display:false}},
      scales:{
        x:{ticks:{color:"cyan"},grid:{color:"#222"}},
        y:{ticks:{color:"cyan"},grid:{color:"#222"}}
      }
    }
  });

  function actualizarHora(){
    horaDiv.innerText="üïí "+new Date().toLocaleTimeString('es-ES',{hour12:false});
    verificarTitileo();
  }
  setInterval(actualizarHora,1000);
  actualizarHora();

  function _tecla(t){if(t==="Borrar")display.innerText=display.innerText.slice(0,-1);else display.innerText+=t;}

  function colorPorCuota(c){if(c<2)return"blue";if(c<10)return"purple";return"pink";}

  function _guardar(){
    const cuota=parseFloat(display.innerText.trim());
    if(isNaN(cuota))return;
    fetch("/guardar",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({cuota})})
    .then(r=>r.json())
    .then(d=>{
      display.innerText="";
      mensajeIA.innerText=(d.prediccion&&d.prediccion!=="clear")?d.prediccion:"";
      const span=document.createElement("span");
      span.innerText=cuota.toFixed(2);
      span.style.color=colorPorCuota(cuota);
      historialDiv.appendChild(span);
      historialDiv.scrollLeft=historialDiv.scrollWidth;
      actualizarGrafico();
    });
  }

  function _deshacer(){
    fetch("/borrar_ultimo",{method:"POST"}).then(()=>{
      if(historialDiv.lastChild)historialDiv.removeChild(historialDiv.lastChild);
      actualizarGrafico();mensajeIA.innerText="";
    });
  }

  function _limpiarPantalla(){
    if(!confirm("‚ö†Ô∏è ¬øSeguro que deseas borrar el historial y reiniciar la pantalla?"))return;
    fetch("/limpiar_todo",{method:"POST"}).then(()=>{
      historialDiv.innerHTML="";mensajeIA.innerText="";display.innerText="";
      grafico.data.labels=[];grafico.data.datasets[0].data=[];
      grafico.update();alert("‚úÖ Pantalla e historial reiniciados.");
    });
  }

  function actualizarGrafico(){
    const cuotas=Array.from(historialDiv.children).map(s=>parseFloat(s.innerText));
    let data=[];let valor=0;
    cuotas.forEach(c=>{if(c<2)valor-=1;else valor+=1;data.push(valor);});
    grafico.data.labels=data.map((_,i)=>i+1);
    grafico.data.datasets[0].data=data;
    grafico.data.datasets[0].borderColor=cuotas.map(c=>colorPorCuota(c));
    grafico.data.datasets[0].pointBackgroundColor=cuotas.map(c=>colorPorCuota(c));
    grafico.update();

    if(!usuarioMoviendoGrafico){
      const chartArea=ctx.canvas.parentNode;
      chartArea.scrollLeft=chartArea.scrollWidth;
    }
  }

  const chartArea=ctx.canvas.parentNode;
  chartArea.style.overflowX="auto";
  chartArea.addEventListener("mousedown",()=>usuarioMoviendoGrafico=true);
  chartArea.addEventListener("mouseup",()=>{
    usuarioMoviendoGrafico=false;
    chartArea.scrollLeft=chartArea.scrollWidth;
  });

  function analizarEntrada(){
    const texto=input.value.trim();
    const match=texto.match(/([\d.]+)x\s*(\d{2}):(\d{2}):(\d{2})/);
    if(!match)return;
    const mult=parseFloat(match[1]);
    const h=parseInt(match[2]),m=parseInt(match[3]),s=parseInt(match[4]);
    const base=new Date();base.setHours(h,m,s,0);
    const nuevo=new Date(base.getTime()+mult*60000);
    tiempoObjetivo=nuevo;
    const nh=String(nuevo.getHours()).padStart(2,"0");
    const nm=String(nuevo.getMinutes()).padStart(2,"0");
    const ns=String(nuevo.getSeconds()).padStart(2,"0");
    input.value=`${match[1]}x ${nh}:${nm}:${ns}`;
  }

  function verificarTitileo(){
    if(!tiempoObjetivo)return;
    const ahora=new Date();
    const diff=(tiempoObjetivo-ahora)/1000;
    if(diff<=15 && diff>=0){input.classList.add("titilar");}
    else{input.classList.remove("titilar");}
  }

  btn.onclick=analizarEntrada;
  input.addEventListener("paste",()=>setTimeout(analizarEntrada,100));

  window.tecla=_tecla;
  window.guardar=_guardar;
  window.deshacer=_deshacer;
  window.limpiarPantalla=_limpiarPantalla;
});
</script>
</body>
</html>
