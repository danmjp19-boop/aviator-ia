<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const display = document.getElementById("display");
const historialDiv = document.getElementById("historial");
const mensajeIA = document.getElementById("mensaje_ia");
const horaDiv = document.getElementById("hora");
const ctx = document.getElementById("grafico").getContext("2d");

let datos = [];
let coloresPuntos = [];

let grafico = new Chart(ctx, {
    type: "line",
    data: {
        labels: [],
        datasets: [{
            label: "Tendencia",
            data: [],
            borderColor: "cyan",
            borderWidth: 2,
            pointRadius: 6,
            pointBackgroundColor: coloresPuntos,
            pointBorderColor: [],       // se llenar√° din√°micamente con blanco
            pointBorderWidth: 2,
            tension: 0
        }]
    },
    options: {
        responsive: true,
        animation: false,
        layout: { padding: 8 },
        scales: {
            x: {
                ticks: { color: "#0ff", stepSize: 1 },
                grid: { color: "#033" }
            },
            y: {
                ticks: { color: "#0ff", stepSize: 0.25 },
                min: -1.5,
                max: 1.5,
                grid: {
                    color: ctx => (ctx.tick && ctx.tick.value === 0) ? 'red' : '#8a4f1a' // cero rojo, resto naranja oscuro
                }
            }
        },
        plugins: {
            legend: { labels: { color: "#0ff" } }
        },
        elements: {
            point: { hoverRadius: 8 }
        }
    }
});

function actualizarHora() {
    horaDiv.innerText = "üïí " + new Date().toLocaleTimeString('es-ES', {hour12:false});
}
setInterval(actualizarHora, 1000);
actualizarHora();

function tecla(t) {
    if (t === "Borrar") display.innerText = display.innerText.slice(0, -1);
    else display.innerText += t;
}

function guardar() {
    const cuota = display.innerText.trim();
    if (!cuota) return;

    fetch("/guardar", {
        method: "POST",
        headers: {"Content-Type": "application/x-www-form-urlencoded"},
        body: new URLSearchParams({cuota})
    })
    .then(r => r.json())
    .then(d => {
        display.innerText = "";

        if (d.prediccion && d.prediccion !== "clear") {
            mensajeIA.innerText = d.prediccion;
            mensajeIA.style.opacity = 1;
        } else {
            mensajeIA.innerText = "";
            mensajeIA.style.opacity = 0;
        }

        const valor = parseFloat(cuota);
        const referencia = 1.5;
        const normalizado = valor - referencia; // **no divido**: uso la diferencia directa

        // color por rango (punto interior)
        let color = valor < 2 ? "blue" : valor < 10 ? "purple" : "pink";

        // push datos
        datos.push(normalizado);
        coloresPuntos.push(color);
        grafico.data.labels.push(datos.length);
        grafico.data.datasets[0].data.push(normalizado);

        // asegurar borde blanco en cada punto
        const bordes = grafico.data.datasets[0].pointBorderColor || [];
        bordes.push("#ffffff");
        grafico.data.datasets[0].pointBorderColor = bordes;

        grafico.update();

        const span = document.createElement("span");
        span.innerText = valor.toFixed(2);
        historialDiv.appendChild(span);
        historialDiv.scrollLeft = historialDiv.scrollWidth;
        actualizarAnalisis();
    })
    .catch(() => alert("‚ö†Ô∏è Error al conectar con el servidor."));
}

function deshacer() {
    fetch("/borrar_ultimo", {method:"POST"}).then(()=>{
        if (datos.length>0){
            datos.pop();
            coloresPuntos.pop();
            grafico.data.labels.pop();
            grafico.data.datasets[0].data.pop();
            grafico.data.datasets[0].pointBackgroundColor.pop();
            grafico.data.datasets[0].pointBorderColor.pop();
            grafico.update();
        }
        if (historialDiv.children.length>0)
            historialDiv.removeChild(historialDiv.lastChild);
        mensajeIA.innerText = "";
        mensajeIA.style.opacity = 0;
        actualizarAnalisis();
    });
}

function limpiarPantalla(){
    if(!confirm("‚ö†Ô∏è ¬øSeguro que deseas borrar todo y reiniciar?")) return;
    fetch("/limpiar_todo",{method:"POST"})
    .then(()=> {
        historialDiv.innerHTML="";
        display.innerText="";
        mensajeIA.innerText="";
        mensajeIA.style.opacity=0;
        datos=[];
        coloresPuntos=[];
        grafico.data.labels=[];
        grafico.data.datasets[0].data=[];
        grafico.data.datasets[0].pointBackgroundColor=[];
        grafico.data.datasets[0].pointBorderColor=[];
        grafico.update();
        alert("‚úÖ Pantalla e historial reiniciados.");
        actualizarAnalisis();
    });
}

function actualizarAnalisis(){
    fetch("/analisis")
    .then(r=>r.json())
    .then(d=>{
        document.getElementById("resumen_analitico").innerText = d.resumen;
    })
    .catch(()=>{
        document.getElementById("resumen_analitico").innerText = "Error al obtener an√°lisis.";
    });
}

actualizarAnalisis();
setInterval(actualizarAnalisis, 5000);
</script>
</body>
</html>