<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aviator Pronosticador IA</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>

  <style>
    body {
      background-color: #000;
      color: cyan;
      font-family: Arial, sans-serif;
      text-align: center;
    }
    .container {
      margin: 20px auto;
      padding: 15px;
      border: 2px solid cyan;
      border-radius: 15px;
      box-shadow: 0 0 20px cyan;
      width: 85%;
      max-width: 600px;
    }
    canvas {
      background-color: #111;
      width: 100%;
      height: 300px;
      border: 1px solid cyan;
      border-radius: 10px;
    }
    #mensaje_ia {
      color: #fff;
      margin: 10px 0;
      font-weight: bold;
    }
    #historial span {
      margin: 0 3px;
    }
    button {
      margin: 4px;
      padding: 8px 15px;
      background-color: cyan;
      color: black;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    button:hover {
      background-color: #00ffffa0;
    }
  </style>
</head>

<body>
  <h2>‚úàÔ∏è Aviator Pronosticador IA</h2>
  <div id="hora"></div>
  <p><strong id="correo">{{ correo }}</strong> | 
     <a href="/logout" style="color:red;text-decoration:none;">Cerrar sesi√≥n</a></p>

  <div class="container">
    <canvas id="grafico"></canvas>
  </div>

  <div id="mensaje_ia"></div>

  <div id="display" style="font-size:1.5em;color:white;margin:10px;"></div>

  <div>
    <button onclick="tecla('1')">1</button>
    <button onclick="tecla('2')">2</button>
    <button onclick="tecla('3')">3</button>
    <button onclick="tecla('.')">.</button>
    <button onclick="tecla('Borrar')">‚Üê</button>
  </div>

  <div>
    <button onclick="guardar()">Ingresar</button>
    <button onclick="deshacer()">Deshacer</button>
    <button onclick="limpiarPantalla()">Limpiar</button>
  </div>

  <div id="historial" style="margin-top:10px;overflow-x:auto;white-space:nowrap;"></div>

  <script>
  document.addEventListener("DOMContentLoaded",()=>{

    const display = document.getElementById("display");
    const historialDiv = document.getElementById("historial");
    const mensajeIA = document.getElementById("mensaje_ia");
    const horaDiv = document.getElementById("hora");
    const graficoCanvas = document.getElementById("grafico").getContext("2d");

    function colorPorCuota(c){ if(c < 2) return "blue"; if(c < 10) return "purple"; return "pink"; }

    function encontrarPicosYValles(arr){
      const peaks = [], valleys = [];
      for(let i=1;i<arr.length-1;i++){
        if(arr[i] > arr[i-1] && arr[i] > arr[i+1]) peaks.push(arr[i]);
        if(arr[i] < arr[i-1] && arr[i] < arr[i+1]) valleys.push(arr[i]);
      }
      const sortedDesc = [...arr].sort((a,b)=>b-a);
      const sortedAsc  = [...arr].sort((a,b)=>a-b);
      const uniq = (a)=>[...new Set(a)];
      const p = uniq(peaks.concat(sortedDesc.slice(0,3))).sort((a,b)=>b-a).slice(0,2);
      const v = uniq(valleys.concat(sortedAsc.slice(0,3))).sort((a,b)=>a-b).slice(0,2);
      return {
        max1: p[0] ?? sortedDesc[0],
        max2: p[1] ?? (p[0] ?? sortedDesc[0]),
        min1: v[0] ?? sortedAsc[0],
        min2: v[1] ?? (v[0] ?? sortedAsc[0])
      };
    }

    const referencePlugin = {
      id: 'referenceLines',
      afterDraw: chart => {
        const ctx = chart.ctx;
        const area = chart.chartArea;
        const yScale = chart.scales['y'];
        const data = chart.data.datasets[0].data;
        if(!data || data.length === 0) return;

        const {max1,max2,min1,min2} = encontrarPicosYValles(data);

        const drawLine = (y, color, width=2, dash=[]) => {
          const yPixel = yScale.getPixelForValue(y);
          ctx.save();
          ctx.beginPath();
          ctx.setLineDash(dash);
          ctx.moveTo(area.left, yPixel);
          ctx.lineTo(area.right, yPixel);
          ctx.lineWidth = width;
          ctx.strokeStyle = color;
          ctx.stroke();
          ctx.restore();
        };

        drawLine(0,'white',2,[]);
        drawLine(max1,'red',2,[]);
        if(max2!==max1) drawLine(max2,'red',1.5,[6,4]);
        drawLine(min1,'lime',2,[]);
        if(min2!==min1) drawLine(min2,'lime',1.5,[6,4]);

        ctx.save();
        ctx.font = '11px Arial';
        ctx.fillStyle = 'white';
        ctx.fillText('0', area.right - 22, yScale.getPixelForValue(0) - 6);
        ctx.fillStyle = 'red';
        ctx.fillText(max1.toFixed(2), area.right - 55, yScale.getPixelForValue(max1) - 6);
        if(max2!==max1) ctx.fillText(max2.toFixed(2), area.right - 55, yScale.getPixelForValue(max2) + 10);
        ctx.fillStyle = 'lime';
        ctx.fillText(min1.toFixed(2), area.right - 55, yScale.getPixelForValue(min1) - 6);
        if(min2!==min1) ctx.fillText(min2.toFixed(2), area.right - 55, yScale.getPixelForValue(min2) + 10);
        ctx.restore();
      }
    };

    const grafico = new Chart(graficoCanvas, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Tendencia',
          data: [],
          borderColor: 'cyan',
          borderWidth: 2,
          pointRadius: 5,
          pointBackgroundColor: [],
          tension: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'nearest', intersect: false },
        plugins: {
          legend: { display: false },
          zoom: {
            pan: { enabled: true, mode: 'xy', threshold: 5 },
            zoom: {
              wheel: { enabled: true, speed: 0.08 },
              pinch: { enabled: true },
              mode: 'xy'
            }
          }
        },
        scales: {
          x: { ticks: { color: 'cyan' }, grid: { color: '#222' } },
          y: { ticks: { color: 'cyan' }, grid: { color: '#222' } }
        }
      },
      plugins: [ Chart.registry.getPlugin('zoom'), referencePlugin ]
    });

    const hammerArea = new Hammer(document.getElementById('grafico'));
    hammerArea.get('pinch').set({ enable: true });
    hammerArea.on('pinchstart pinchmove pinchend', e => e.preventDefault());

    function actualizarGrafico(){
      const cuotas = Array.from(historialDiv.children).map(s => parseFloat(s.innerText));
      let valor = 0;
      const serie = cuotas.map(c => { if (c < 2) valor -= 1; else valor += 1; return valor; });

      grafico.data.labels = serie.map((_,i) => i+1);
      grafico.data.datasets[0].data = serie;
      grafico.data.datasets[0].pointBackgroundColor = cuotas.map(c => colorPorCuota(c));

      const max = Math.max(...serie, 0);
      const min = Math.min(...serie, 0);
      const absMax = Math.max(Math.abs(max), Math.abs(min)) || 1;
      grafico.options.scales.y.min = -absMax - 1;
      grafico.options.scales.y.max = absMax + 1;

      grafico.update('none');
    }

    async function _guardar(){
      const cuota = parseFloat(display.innerText.trim());
      if(isNaN(cuota)) return;
      try{
        const res = await fetch("/guardar", {
          method:"POST",
          headers:{"Content-Type":"application/x-www-form-urlencoded"},
          body: new URLSearchParams({cuota})
        });
        const d = await res.json();
        display.innerText = "";
        mensajeIA.innerText = (d.prediccion && d.prediccion !== "clear") ? d.prediccion : "";
        const span = document.createElement("span");
        span.innerText = cuota.toFixed(2);
        span.style.color = "white";
        historialDiv.appendChild(span);
        historialDiv.scrollLeft = historialDiv.scrollWidth;
        actualizarGrafico();
      }catch(err){
        const span = document.createElement("span");
        span.innerText = cuota.toFixed(2);
        span.style.color = "white";
        historialDiv.appendChild(span);
        historialDiv.scrollLeft = historialDiv.scrollWidth;
        actualizarGrafico();
      }
    }

    async function _deshacer(){
      await fetch("/borrar_ultimo",{method:"POST"});
      if(historialDiv.lastChild) historialDiv.removeChild(historialDiv.lastChild);
      mensajeIA.innerText = "";
      actualizarGrafico();
    }

    async function _limpiarPantalla(){
      if(!confirm("‚ö†Ô∏è ¬øSeguro que deseas borrar el historial y reiniciar la pantalla?")) return;
      await fetch("/limpiar_todo",{method:"POST"});
      historialDiv.innerHTML = "";
      mensajeIA.innerText = "";
      display.innerText = "";
      grafico.data.labels = [];
      grafico.data.datasets[0].data = [];
      grafico.update();
    }

    function _tecla(t){ if(t === "Borrar") display.innerText = display.innerText.slice(0,-1); else display.innerText += t; }

    function actualizarHora(){ horaDiv.innerText = "üïí "+ new Date().toLocaleTimeString('es-ES',{hour12:false}); }
    setInterval(actualizarHora,1000);
    actualizarHora();

    window.tecla = _tecla;
    window.guardar = _guardar;
    window.deshacer = _deshacer;
    window.limpiarPantalla = _limpiarPantalla;

    document.getElementById('grafico').addEventListener('dblclick', ()=> grafico.resetZoom());
    actualizarGrafico();
  });
  </script>
</body>
</html>
