<script>
document.addEventListener("DOMContentLoaded",()=>{

  const display=document.getElementById("display");
  const historialDiv=document.getElementById("historial");
  const mensajeIA=document.getElementById("mensaje_ia");
  const horaDiv=document.getElementById("hora");
  const input=document.getElementById("analisisInput");
  const btn=document.getElementById("analizarBtn");
  const graficoCtx=document.getElementById("grafico").getContext("2d");

  function colorPorCuota(c){if(c<2)return"blue";if(c<10)return"purple";return"pink";}

  const referencePlugin={id:'referenceLines',afterDraw:chart=>{const ctx=chart.ctx,area=chart.chartArea,yScale=chart.scales['y'];const data=chart.data.datasets[0].data;if(!data||data.length===0)return;const maxVal=Math.max(...data);const minVal=Math.min(...data);const soporte=minVal,resistencia=maxVal;const soporte2=soporte+(resistencia-soporte)*0.25;const resistencia2=resistencia-(resistencia-soporte)*0.25;const drawLine=(y,color,w=2,dash=[])=>{const yPixel=yScale.getPixelForValue(y);ctx.save();ctx.beginPath();ctx.setLineDash(dash);ctx.moveTo(area.left,yPixel);ctx.lineTo(area.right,yPixel);ctx.lineWidth=w;ctx.strokeStyle=color;ctx.stroke();ctx.restore();};drawLine(resistencia,'red',2,[]);drawLine(resistencia2,'red',1,[6,4]);drawLine(soporte2,'lime',1,[6,4]);drawLine(soporte,'lime',2,[]);}};

  function clampOrResetScales(chart){try{const y=chart.scales['y'];if(!y)return;let min=Number(y.min);let max=Number(y.max);if(!isFinite(min)||!isFinite(max)||Math.abs(max-min)<0.05){chart.resetZoom();return;}const data=chart.data.datasets[0].data||[];const absMaxData=Math.max(1,Math.abs(Math.max(...data)),Math.abs(Math.min(...data)));const limit=Math.max(5,absMaxData*10);if(min<-limit)min=-limit;if(max>limit)max=limit;if(min!==y.min||max!==y.max){chart.options.scales.y.min=min;chart.options.scales.y.max=max;chart.update('none');}}catch(e){chart.resetZoom();}}

  const grafico=new Chart(graficoCtx,{type:'line',data:{labels:[],datasets:[{label:'Tendencia',data:[],borderColor:'cyan',borderWidth:2,pointRadius:5,pointBackgroundColor:[],tension:0}]},options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'nearest',intersect:false},plugins:{legend:{display:false},zoom:{pan:{enabled:true,mode:'xy',modifierKey:null,threshold:5,onPan:({chart})=>{clampOrResetScales(chart);}},zoom:{wheel:{enabled:true,speed:0.12,threshold:1},pinch:{enabled:true,threshold:1},mode:'xy',onZoom:({chart})=>{clampOrResetScales(chart);},limits:{x:{min:1,max:1000000,minRange:1},y:{min:-999999,max:999999}}}}},scales:{x:{ticks:{color:'cyan'},grid:{color:'#222'}},y:{ticks:{color:'cyan'},grid:{color:'#222'}}}},plugins:[Chart.registry.getPlugin('zoom'),referencePlugin]});

  const hammerArea=new Hammer(document.getElementById('graficoWrap'));
  hammerArea.get('pinch').set({enable:true});
  hammerArea.on('pinchstart pinchmove pinchend',e=>e.preventDefault());

  function actualizarGrafico(){
    const cuotas=Array.from(historialDiv.children).map(s=>parseFloat(s.innerText));
    if(cuotas.length===0){grafico.data.labels=[];grafico.data.datasets[0].data=[];grafico.update();return;}
    let valor=0;const serie=cuotas.map(c=>{valor+=(c<2?-1:1);return valor;});
    grafico.data.labels=serie.map((_,i)=>i+1);
    grafico.data.datasets[0].data=serie;
    grafico.data.datasets[0].pointBackgroundColor=cuotas.map(c=>colorPorCuota(c));
    const max=Math.max(...serie,0),min=Math.min(...serie,0);
    const absMax=Math.max(Math.abs(max),Math.abs(min))||1;
    grafico.options.scales.y.min=-absMax-1;
    grafico.options.scales.y.max=absMax+1;
    grafico.update('none');
  }

  // === BOTONES ORIGINALES ===
  window.tecla=t=>{if(t==="Borrar")display.innerText=display.innerText.slice(0,-1);else display.innerText+=t;};
  window.guardar=()=>{const cuota=parseFloat(display.innerText.trim());if(isNaN(cuota))return;
    fetch("/guardar",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({cuota})})
    .then(r=>r.json()).then(d=>{display.innerText="";mensajeIA.innerText=(d.prediccion&&d.prediccion!=="clear")?d.prediccion:"";const span=document.createElement("span");span.innerText=cuota.toFixed(2);span.style.color="white";historialDiv.appendChild(span);historialDiv.scrollLeft=historialDiv.scrollWidth;actualizarGrafico();})
    .catch(()=>{const span=document.createElement("span");span.innerText=cuota.toFixed(2);span.style.color="white";historialDiv.appendChild(span);historialDiv.scrollLeft=historialDiv.scrollWidth;actualizarGrafico();});
  };
  window.deshacer=()=>{fetch("/borrar_ultimo",{method:"POST"}).then(()=>{if(historialDiv.lastChild)historialDiv.removeChild(historialDiv.lastChild);mensajeIA.innerText="";actualizarGrafico();}).catch(()=>{if(historialDiv.lastChild)historialDiv.removeChild(historialDiv.lastChild);actualizarGrafico();});};
  window.limpiarPantalla=()=>{if(!confirm("âš ï¸ Â¿Seguro que deseas borrar el historial y reiniciar la pantalla?"))return;
    fetch("/limpiar_todo",{method:"POST"}).then(()=>{historialDiv.innerHTML="";mensajeIA.innerText="";display.innerText="";
    grafico.data.labels=[];grafico.data.datasets[0].data=[];grafico.update();alert("âœ… Pantalla e historial reiniciados.");})
    .catch(()=>{historialDiv.innerHTML="";grafico.data.labels=[];grafico.data.datasets[0].data=[];grafico.update();});
  };

  btn.onclick=()=>{const texto=input.value.trim();const match=texto.match(/([\d.]+)x\s*(\d{2}):(\d{2}):(\d{2})/);
    if(!match)return;const mult=parseFloat(match[1]);const h=parseInt(match[2]),m=parseInt(match[3]),s=parseInt(match[4]);
    const base=new Date();base.setHours(h,m,s,0);const nuevo=new Date(base.getTime()+mult*60000);
    const nh=String(nuevo.getHours()).padStart(2,"0"),nm=String(nuevo.getMinutes()).padStart(2,"0"),ns=String(nuevo.getSeconds()).padStart(2,"0");
    input.value=`${match[1]}x ${nh}:${nm}:${ns}`;};

  // =======================
  // ðŸ’– HORA ROSA 10s ANTES
  // =======================
  const horasBase=[
    "14:18:47","14:25:27","14:29:58","14:31:02","14:32:32","14:33:49","14:35:05","14:38:59","14:41:36","14:42:48",
    "14:46:51","14:50:24","14:54:58","14:56:09","14:57:41","14:58:54","14:59:39","15:01:27","15:16:32","15:17:40",
    "15:21:16","15:24:56","15:26:35","15:28:29","15:32:34","15:36:16","15:37:33","15:42:12","15:44:51","15:55:34",
    "16:07:01","16:17:10","16:22:45","16:32:40","16:35:27","16:38:44","16:50:01","16:52:20","16:54:41","17:03:23",
    "17:04:36","17:09:38","17:10:49","17:13:45","17:14:33","17:17:55","17:19:25","17:20:58","17:26:10","17:32:18",
    "17:41:50","17:42:47","17:51:58","17:54:51","17:55:32"
  ];

  // convertir lista en segundos del dÃ­a
  const horasSegundos = horasBase.map(h=>{
    const [H,M,S]=h.split(":").map(Number);
    return H*3600+M*60+S;
  });

  let highlightTimeout=null;
  let isHighlighted=false;

  function actualizarHora(){
    const ahora=new Date();
    const horaStr=ahora.toLocaleTimeString('es-ES',{hour12:false});
    horaDiv.innerText="ðŸ•’ "+horaStr;

    const segundosActuales=ahora.getHours()*3600+ahora.getMinutes()*60+ahora.getSeconds();

    // Si estamos dentro de los 10 segundos previos a una coincidencia
    const debeResaltar=horasSegundos.some(seg=> segundosActuales>=seg-10 && segundosActuales<=seg );

    if(debeResaltar && !isHighlighted){
      isHighlighted=true;
      horaDiv.classList.add("hora-rosa");
      clearTimeout(highlightTimeout);
      highlightTimeout=setTimeout(()=>{
        horaDiv.classList.remove("hora-rosa");
        isHighlighted=false;
        highlightTimeout=null;
      },7000);
    }
  }

  setInterval(actualizarHora,1000);
  actualizarHora();

  document.getElementById('grafico').addEventListener('dblclick',()=>grafico.resetZoom());

  const ro=new MutationObserver(()=>{actualizarGrafico();clampOrResetScales(grafico);});
  ro.observe(historialDiv,{childList:true});
  actualizarGrafico();
});
</script>
