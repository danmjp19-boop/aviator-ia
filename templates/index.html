<!DOCTYPE html>   
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>‚úàÔ∏è Aviator Pronosticador IA</title>
<style>
/* tus estilos EXACTOS (no modifiqu√© visual) */
body{background:#000;color:cyan;font-family:Arial,sans-serif;text-align:center;margin:0;padding:20px;}
h1{color:#00ffff;margin:6px 0;}
.container{max-width:400px;margin:0 auto;background:#111;padding:20px;border-radius:15px;box-shadow:0 0 15px cyan;display:flex;flex-direction:column;align-items:center;}
#hora-analisis{display:flex;justify-content:space-between;align-items:center;width:100%;margin-bottom:10px;}
#hora{font-size:1.2em;color:#0ff;letter-spacing:1px;}
#analisisInput{width:120px;padding:5px;border:1px solid cyan;background:#000;color:cyan;border-radius:8px;text-align:center;}
#analizarBtn{padding:6px 10px;background:cyan;color:#000;border:none;border-radius:8px;font-weight:bold;cursor:pointer;}
#display{background:#000;color:#0ff;font-size:2em;padding:10px;border:2px solid cyan;border-radius:10px;min-height:40px;margin-bottom:15px;width:100%;}
.teclado button{width:30%;margin:5px;padding:10px;font-size:1.2em;border-radius:10px;background:#022;color:cyan;border:1px solid #0ff;cursor:pointer;}
.acciones{margin-top:10px;display:flex;justify-content:space-between;flex-wrap:wrap;gap:10px;width:100%;}
.acciones button{flex:1;padding:10px;border-radius:10px;background:cyan;color:black;font-weight:bold;cursor:pointer;}
.limpiar{background:#f00;color:white;margin-top:20px;width:100%;font-weight:bold;border:2px solid #faa;}
#graficoWrap{width:100%;height:260px;background:#000;border:2px solid cyan;border-radius:10px;padding:8px;margin-top:12px;overflow:hidden;}
/* importante para gestos en m√≥vil */
#graficoWrap canvas{width:100%!important;height:100%!important;display:block;touch-action:none;-ms-touch-action:none;}
#mensaje_ia{margin-top:15px;font-size:1.2em;color:lime;min-height:1.5em;}
#historial{margin-top:15px;display:flex;overflow-x:auto;gap:6px;padding-bottom:10px;border-top:1px solid cyan;border-bottom:1px solid cyan;width:100%;}
#historial span{background:#033;padding:5px 10px;border-radius:5px;color:white;white-space:nowrap;font-weight:bold;}
.user-bar{margin-bottom:10px;text-align:center;font-size:0.95em;}
.user-bar span{color:#0ff;font-weight:bold;}
.user-bar a{color:#ff5555;text-decoration:none;font-weight:bold;margin-left:8px;}
.user-bar a:hover{text-decoration:underline;}

/* --- estilos del bloque a√±adido (no tocan el resto) --- */
#alertaBox {
  width: 100%;
  margin: 8px 0 10px 0;
  display: none; /* se mostrar√° cuando haya alerta */
  justify-content: center;
  align-items: center;
  border-radius: 8px;
  padding: 8px;
  box-shadow: 0 0 6px cyan;
  border: 1px solid rgba(0,255,255,0.3);
  background: rgba(0,0,0,0.6);
}
.alerta-inner {
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:4px;
}
.corazon {
  font-size:20px;
  color: #ff99cc;
  display:inline-block;
  animation: latido 1s infinite;
}
@keyframes latido {
  0%,100%{ transform: scale(1); }
  50%{ transform: scale(1.25); }
}
.hora-peq {
  font-size:0.85em;
  color: #ff99cc;
  font-weight:600;
}
</style>
</head>
<body>
<h1>‚úàÔ∏è Aviator Pronosticador IA</h1>

<div class="user-bar">
  <span>üìß {{ usuario }}</span> |
  <a href="/logout">Cerrar sesi√≥n</a>
</div>

<div class="container">
  <div id="hora-analisis">
    <div id="hora"></div>
    <div>
      <input type="text" id="analisisInput" placeholder="1.84x 03:52:27">
      <button id="analizarBtn">Iniciar</button>
    </div>
  </div>

  <div id="display"></div>

  <!-- ----- MT-2 ----- -->
  <div id="mt2" style="width:100%;margin-bottom:8px;display:flex;justify-content:center;align-items:center;gap:6px;background:#111;padding:4px;border:1px solid cyan;border-radius:8px;box-shadow:0 0 6px cyan;font-size:0.9em;">
    <span style="color:cyan;font-weight:bold;">MT-2</span>
    <input id="mt2_semilla" type="text" placeholder="04:33:58" style="width:80px;text-align:center;background:#000;border:1px solid cyan;color:cyan;border-radius:6px;padding:3px;">
    <button id="mt2_btn" style="background:cyan;color:#000;border:none;border-radius:6px;font-weight:bold;cursor:pointer;padding:3px 6px;">‚ñ∂</button>
    <span id="mt2_tiempo" style="min-width:75px;color:lime;font-weight:bold;transition:all .3s;">--:--:--</span>
  </div>
  <!-- ----- fin MT-2 ----- -->

  <!-- ======= BLOQUE NUEVO: coraz√≥n + hora (DEBE IR AQU√ç, debajo de MT-2) ======= -->
  <div id="alertaBox" aria-live="polite">
    <div class="alerta-inner">
      <div class="corazon" role="img" aria-label="Alerta">‚ù§</div>
      <div id="horaAlerta" class="hora-peq">--:--:--</div>
    </div>
  </div>
  <!-- ======= FIN BLOQUE NUEVO ======= -->

  <div class="teclado">
    {% for n in [1,2,3,4,5,6,7,8,9,'.',0,'Borrar'] %}
      <button onclick="tecla('{{n}}')">{{n}}</button>
    {% endfor %}
  </div>

  <div class="acciones">
    <button onclick="guardar()">Ingresar</button>
    <button onclick="deshacer()">‚Ü©Ô∏è Deshacer</button>
  </div>

  <button class="limpiar" onclick="limpiarPantalla()">üßπ Limpiar Pantalla</button>

  <div id="mensaje_ia"></div>

  <div id="graficoWrap">
    <canvas id="grafico"></canvas>
  </div>
</div>

<h2>Historial</h2>
<div id="historial">
  {% for h in historial %}
    <span>{{'%.2f'|format(h)}}</span>
  {% endfor %}
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.2.1/dist/chartjs-plugin-zoom.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded",()=>{

  const display=document.getElementById("display");
  const historialDiv=document.getElementById("historial");
  const mensajeIA=document.getElementById("mensaje_ia");
  const horaDiv=document.getElementById("hora");
  const input=document.getElementById("analisisInput");
  const btn=document.getElementById("analizarBtn");
  const graficoCtx=document.getElementById("grafico").getContext("2d");

  function colorPorCuota(c){if(c<2)return"blue";if(c<10)return"purple";return"pink";}

  const referencePlugin={
    id:'referenceLines',
    afterDraw:chart=>{
      const ctx=chart.ctx, area=chart.chartArea, yScale=chart.scales['y'];
      const data=chart.data.datasets[0].data;
      if(!data||data.length===0)return;
      const maxVal=Math.max(...data);
      const minVal=Math.min(...data);
      const soporte=minVal,resistencia=maxVal;
      const soporte2=soporte+(resistencia-soporte)*0.25;
      const resistencia2=resistencia-(resistencia-soporte)*0.25;
      const drawLine=(y,color,w=2,dash=[])=>{
        const yPixel=yScale.getPixelForValue(y);
        ctx.save();ctx.beginPath();ctx.setLineDash(dash);
        ctx.moveTo(area.left,yPixel);ctx.lineTo(area.right,yPixel);
        ctx.lineWidth=w;ctx.strokeStyle=color;ctx.stroke();ctx.restore();
      };
      drawLine(resistencia,'red',2,[]);
      drawLine(resistencia2,'red',1,[6,4]);
      drawLine(soporte2,'lime',1,[6,4]);
      drawLine(soporte,'lime',2,[]);
    }
  };

  function clampOrResetScales(chart){
    try{
      const y=chart.scales['y'];
      if(!y)return;
      let min=Number(y.min);
      let max=Number(y.max);
      if(!isFinite(min)||!isFinite(max)||Math.abs(max-min)<0.05){
        chart.resetZoom();return;
      }
      const data=chart.data.datasets[0].data||[];
      const absMaxData=Math.max(1,Math.abs(Math.max(...data)),Math.abs(Math.min(...data)));
      const limit=Math.max(5,absMaxData*10);
      if(min<-limit)min=-limit;
      if(max>limit)max=limit;
      if(min!==y.min||max!==y.max){
        chart.options.scales.y.min=min;
        chart.options.scales.y.max=max;
        chart.update('none');
      }
    }catch(e){chart.resetZoom();}
  }

  const grafico=new Chart(graficoCtx,{
    type:'line',
    data:{labels:[],datasets:[{label:'Tendencia',data:[],borderColor:'cyan',borderWidth:2,pointRadius:5,pointBackgroundColor:[],tension:0}]},
    options:{
      responsive:true,
      maintainAspectRatio:false,
      interaction:{mode:'nearest',intersect:false},
      plugins:{
        legend:{display:false},
        zoom:{
          pan:{
            enabled:true,
            mode:'xy',
            modifierKey:null,
            threshold:5,
            // üëá agregado: validar escalas en pan
            onPan:({chart})=>{
              clampOrResetScales(chart);
            }
          },
          zoom:{
            wheel:{enabled:true,speed:0.12,threshold:1},
            pinch:{enabled:true,threshold:1},
            mode:'xy',
            onZoom:({chart})=>{
              clampOrResetScales(chart);
            },
            // üëá agregado: l√≠mites para evitar zoom extremo
            limits:{
              x:{min:1,max:1000000,minRange:1},
              y:{min:-999999,max:999999}
            }
          }
        }
      },
      scales:{
        x:{ticks:{color:'cyan'},grid:{color:'#222'}},
        y:{ticks:{color:'cyan'},grid:{color:'#222'}}
      }
    },
    plugins:[Chart.registry.getPlugin('zoom'),referencePlugin]
  });

  // üëá cambio: ahora el gesto se captura en el contenedor
  const hammerArea=new Hammer(document.getElementById('graficoWrap'));
  hammerArea.get('pinch').set({enable:true});
  hammerArea.on('pinchstart pinchmove pinchend',e=>e.preventDefault());

  function actualizarGrafico(){
    const cuotas=Array.from(historialDiv.children).map(s=>parseFloat(s.innerText));
    if(cuotas.length===0){
      grafico.data.labels=[];grafico.data.datasets[0].data=[];grafico.update();return;
    }
    let valor=0;
    const serie=cuotas.map(c=>{valor+=(c<2?-1:1);return valor;});
    grafico.data.labels=serie.map((_,i)=>i+1);
    grafico.data.datasets[0].data=serie;
    grafico.data.datasets[0].pointBackgroundColor=cuotas.map(c=>colorPorCuota(c));
    const max=Math.max(...serie,0),min=Math.min(...serie,0);
    const absMax=Math.max(Math.abs(max),Math.abs(min))||1;
    grafico.options.scales.y.min=-absMax-1;
    grafico.options.scales.y.max=absMax+1;
    grafico.update('none');
  }

  window.tecla=t=>{if(t==="Borrar")display.innerText=display.innerText.slice(0,-1);else display.innerText+=t;};

  window.guardar=()=>{
    const cuota=parseFloat(display.innerText.trim());
    if(isNaN(cuota))return;
    fetch("/guardar",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({cuota})})
    .then(r=>r.json()).then(d=>{
      display.innerText="";
      mensajeIA.innerText=(d.prediccion&&d.prediccion!=="clear")?d.prediccion:"";
      const span=document.createElement("span");
      span.innerText=cuota.toFixed(2);
      span.style.color="white";
      historialDiv.appendChild(span);
      historialDiv.scrollLeft=historialDiv.scrollWidth;
      actualizarGrafico();
    }).catch(()=>{
      const span=document.createElement("span");
      span.innerText=cuota.toFixed(2);
      span.style.color="white";
      historialDiv.appendChild(span);
      historialDiv.scrollLeft=historialDiv.scrollWidth;
      actualizarGrafico();
    });
  };

  window.deshacer=()=>{
    fetch("/borrar_ultimo",{method:"POST"}).then(()=>{
      if(historialDiv.lastChild)historialDiv.removeChild(historialDiv.lastChild);
      mensajeIA.innerText="";actualizarGrafico();
    }).catch(()=>{if(historialDiv.lastChild)historialDiv.removeChild(historialDiv.lastChild);actualizarGrafico();});
  };

  window.limpiarPantalla=()=>{
    if(!confirm("‚ö†Ô∏è ¬øSeguro que deseas borrar el historial y reiniciar la pantalla?"))return;
    fetch("/limpiar_todo",{method:"POST"}).then(()=>{
      historialDiv.innerHTML="";mensajeIA.innerText="";display.innerText="";
      grafico.data.labels=[];grafico.data.datasets[0].data=[];grafico.update();
      alert("‚úÖ Pantalla e historial reiniciados.");
    }).catch(()=>{historialDiv.innerHTML="";grafico.data.labels=[];grafico.data.datasets[0].data=[];grafico.update();});
  };

  btn.onclick=()=>{
    const texto=input.value.trim();
    const match=texto.match(/([\d.]+)x\s*(\d{2}):(\d{2}):(\d{2})/);
    if(!match)return;
    const mult=parseFloat(match[1]);
    const h=parseInt(match[2]),m=parseInt(match[3]),s=parseInt(match[4]);
    const base=new Date();base.setHours(h,m,s,0);
    const nuevo=new Date(base.getTime()+mult*60000);
    const nh=String(nuevo.getHours()).padStart(2,"0");
    const nm=String(nuevo.getMinutes()).padStart(2,"0");
    const ns=String(nuevo.getSeconds()).padStart(2,"0");
    input.value=`${match[1]}x ${nh}:${nm}:${ns}`;
  };

  function actualizarHora(){horaDiv.innerText="üïí "+new Date().toLocaleTimeString('es-ES',{hour12:false});}
  setInterval(actualizarHora,1000);actualizarHora();

  document.getElementById('grafico').addEventListener('dblclick',()=>grafico.resetZoom());

  const ro=new MutationObserver(()=>{
    actualizarGrafico();
    clampOrResetScales(grafico);
  });
  ro.observe(historialDiv,{childList:true});

  actualizarGrafico();
});
</script>

<!-- ----- Script MT-2 (sin cambios) ----- -->
<script>
(function(){
  function initMT2(){
    const btn=document.getElementById('mt2_btn');
    const input=document.getElementById('mt2_semilla');
    const span=document.getElementById('mt2_tiempo');
    if(!btn||!input||!span)return;
    const intervalos=[
      {h:0,m:0,s:42},
      {h:0,m:1,s:33},
      {h:0,m:2,s:18},
      {h:0,m:2,s:49},
      {h:0,m:3,s:30}
    ];
    let tiempos=[],idx=0,tHandle=null;
    function parseHora(str){
      const p=str.split(':').map(Number);
      if(p.length!==3||p.some(isNaN))return null;
      const d=new Date();d.setHours(p[0],p[1],p[2],0);return d;
    }
    function sumar(base,itv){
      const n=new Date(base.getTime());
      n.setSeconds(n.getSeconds()+(itv.h*3600+itv.m*60+itv.s));
      return n;
    }
    function fmt(d){return d?d.toTimeString().split(' ')[0]:'--:--:--';}
    function actualizar(titila){
      if(idx>=tiempos.length){
        span.textContent='‚úÖ';span.style.color='cyan';span.style.background='';span.style.boxShadow='';return;
      }
      span.textContent=fmt(tiempos[idx]);
      if(titila){span.style.background='red';span.style.color='#fff';span.style.boxShadow='0 0 8px red';}
      else{span.style.background='';span.style.color='lime';span.style.boxShadow='';}
    }
    function verificar(){
      const ahora=new Date();
      if(idx>=tiempos.length){clearInterval(tHandle);tHandle=null;return;}
      const objetivo=tiempos[idx];
      const diff=(objetivo-ahora)/1000;
      const alertWindow=Math.abs(diff)<=10;
      actualizar(alertWindow);
      if(diff<=0){idx++;actualizar(false);}
    }
    function iniciar(){
      const raw=input.value.trim();
      const base=parseHora(raw);
      if(!base){alert('Formato inv√°lido: HH:MM:SS');return;}
      tiempos=[base];
      for(let i=0;i<intervalos.length;i++){tiempos.push(sumar(tiempos[i],intervalos[i]));}
      idx=1;
      if(tHandle){clearInterval(tHandle);tHandle=null;}
      verificar();tHandle=setInterval(verificar,1000);
    }
    btn.addEventListener('click',iniciar);
    input.addEventListener('keydown',function(e){if(e.key==='Enter'){e.preventDefault();iniciar();}});
  }
  if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',initMT2);}else{initMT2();}
})();
</script>

<!-- ======= SCRIPT ADICIONAL: consulta /alert_current y muestra la casilla ======= -->
<script>
(function(){
  const caja=document.getElementById('alertaBox');
  const horaEl=document.getElementById('horaAlerta');
  let hideTimer=null;

  // Actualiza la hora peque√±a cada segundo (si el server devuelve time_full lo usaremos cuando llegue)
  function tickLocalTime(){
    if(!horaEl) return;
    // s√≥lo actualizar si el servidor no ha enviado time_full recientemente
    horaEl.textContent = new Date().toLocaleTimeString('es-ES',{hour12:false});
  }
  setInterval(tickLocalTime,1000);
  tickLocalTime();

  async function checkAlert(){
    try{
      const res = await fetch('/alert_current', {cache: 'no-store'});
      if(!res.ok) return;
      const d = await res.json();
      // soporte para claves en espa√±ol o ingl√©s (activa/active)
      const isActive = d.active === true || d.activa === true || d.active === 'true' || d.activa === 'true';
      // si server devuelve una hora completa preferimos mostrarla
      if(d.time_full) horaEl.textContent = d.time_full;
      if(d.time_full === undefined && d.time_full === null && d.mmss) {
        // mostrar MM:SS si that's all we have
        horaEl.textContent = d.mmss;
      }
      if(isActive){
        if(caja) caja.style.display = 'flex';
        // si server devuelve remaining (en segundos), usarlo; si no, 10s por defecto
        const rem = (typeof d.remaining === 'number' && d.remaining>0) ? d.remaining : 10;
        if(hideTimer) clearTimeout(hideTimer);
        hideTimer = setTimeout(()=>{ if(caja) caja.style.display='none'; }, rem*1000);
      } else {
        // no activa -> ocultar
        if(caja) caja.style.display = 'none';
      }
    }catch(e){
      // errores de red: no hacer nada visible
      // console.log('err alert', e);
    }
  }

  // preguntar cada 1s
  setInterval(checkAlert,1000);
  // y preguntar inmediatamente una vez
  checkAlert();
})();
</script>
<!-- ======= FIN ======= -->

</body>
</html>
