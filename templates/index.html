<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const display = document.getElementById("display");
const historialDiv = document.getElementById("historial");
const mensajeIA = document.getElementById("mensaje_ia");
const horaDiv = document.getElementById("hora");

// === Inicializar grÃ¡fico ===
const grafCanvas = document.createElement("canvas");
grafCanvas.id = "grafico";
grafCanvas.style.background = "#000";
grafCanvas.style.border = "2px solid cyan";
grafCanvas.style.borderRadius = "10px";
grafCanvas.style.marginTop = "15px";
grafCanvas.height = 180;
document.querySelector(".container").appendChild(grafCanvas);

const ctx = grafCanvas.getContext("2d");
let grafico = new Chart(ctx, {
    type: "line",
    data: {
        labels: [],
        datasets: [
            {
                label: "Tendencia",
                data: [],
                borderColor: "white",
                backgroundColor: "rgba(0,255,255,0.3)",
                borderWidth: 2,
                pointBackgroundColor: "white",
                tension: 0.3,
            },
            {
                label: "Soporte",
                data: [],
                borderColor: "lime",
                borderWidth: 1.5,
                borderDash: [5,5],
                pointRadius: 0,
            },
            {
                label: "Resistencia",
                data: [],
                borderColor: "red",
                borderWidth: 1.5,
                borderDash: [5,5],
                pointRadius: 0,
            }
        ]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                labels: { color: "cyan" }
            }
        },
        scales: {
            x: {
                ticks: { color: "cyan" },
                grid: { color: "#222" }
            },
            y: {
                ticks: { color: "cyan" },
                grid: { color: "#222" }
            }
        }
    }
});

// === Actualizar hora ===
function actualizarHora() {
    const ahora = new Date();
    horaDiv.innerText = "ðŸ•’ " + ahora.toLocaleTimeString('es-ES', {hour12:false});
}
setInterval(actualizarHora, 1000);
actualizarHora();

// === Botones ===
function tecla(t) {
    if (t === "Borrar") display.innerText = display.innerText.slice(0,-1);
    else display.innerText += t;
}

// === Guardar cuota ===
function guardar() {
    const cuota = display.innerText.trim();
    if (!cuota) return;
    fetch("/guardar", {
        method: "POST",
        headers: {"Content-Type":"application/x-www-form-urlencoded"},
        body: new URLSearchParams({cuota})
    })
    .then(r=>r.json())
    .then(d=>{
        if (d.error) alert(d.error);
        else {
            display.innerText = "";
            mensajeIA.innerText = (d.prediccion && d.prediccion!=="clear") ? d.prediccion : "";
            const span = document.createElement("span");
            span.innerText = parseFloat(cuota).toFixed(2);
            historialDiv.appendChild(span);
            if (historialDiv.children.length > 100) historialDiv.removeChild(historialDiv.children[0]);
            historialDiv.scrollLeft = historialDiv.scrollWidth;
            actualizarGrafico();
        }
        actualizarAnalisis();
    });
}

// === Deshacer ===
function deshacer() {
    fetch("/borrar_ultimo",{method:"POST"}).then(()=>{
        if(historialDiv.children.length>0) historialDiv.removeChild(historialDiv.lastChild);
        mensajeIA.innerText="";
        actualizarGrafico();
        actualizarAnalisis();
    });
}

// === Limpiar pantalla ===
function limpiarPantalla() {
    if(!confirm("âš ï¸ Â¿Seguro que deseas borrar el historial y reiniciar la pantalla?")) return;
    fetch("/limpiar_todo",{method:"POST"})
    .then(()=> {
        historialDiv.innerHTML="";
        mensajeIA.innerText="";
        display.innerText="";
        grafico.data.labels=[];
        grafico.data.datasets.forEach(ds=>ds.data=[]);
        grafico.update();
        alert("âœ… Pantalla e historial reiniciados.");
    });
}

// === AnÃ¡lisis ===
function actualizarAnalisis() {
    fetch("/analisis")
    .then(r=>r.json())
    .then(d=>{
        document.getElementById("resumen_analitico").innerText=d.resumen;
    })
    .catch(()=>{
        document.getElementById("resumen_analitico").innerText="Error al obtener anÃ¡lisis.";
    });
}
setInterval(actualizarAnalisis,5000);

// === GrÃ¡fico ===
function actualizarGrafico() {
    const cuotas = Array.from(historialDiv.children).map(s=>parseFloat(s.innerText));
    const ultimas = cuotas.slice(-25);
    grafico.data.labels = ultimas.map((_,i)=>i+1);
    grafico.data.datasets[0].data = ultimas;
    grafico.data.datasets[1].data = new Array(ultimas.length).fill(1.0);
    grafico.data.datasets[2].data = new Array(ultimas.length).fill(2.0);
    grafico.update();
}

actualizarAnalisis();
actualizarGrafico();
</script>
